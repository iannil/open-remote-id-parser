name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_TYPE: Release

jobs:
  # ==========================================================================
  # C++ Build and Test
  # ==========================================================================
  cpp-build:
    name: C++ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cmake_generator: "Unix Makefiles"
          - os: macos-latest
            cmake_generator: "Unix Makefiles"
          - os: windows-latest
            cmake_generator: "Visual Studio 17 2022"

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -G "${{ matrix.cmake_generator }}" -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DORIP_BUILD_TESTS=ON -DORIP_BUILD_EXAMPLES=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure

  # ==========================================================================
  # Code Coverage
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install lcov
      run: sudo apt-get install -y lcov

    - name: Configure CMake with coverage
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DORIP_BUILD_TESTS=ON -DORIP_ENABLE_COVERAGE=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

    - name: Collect coverage data
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/googletest/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false
        verbose: true

  # ==========================================================================
  # Sanitizer Check
  # ==========================================================================
  sanitizers:
    name: Sanitizers (ASan, UBSan)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake with sanitizers
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DORIP_BUILD_TESTS=ON -DORIP_ENABLE_SANITIZERS=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests with sanitizers
      working-directory: build
      run: ctest --output-on-failure
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1

  # ==========================================================================
  # Thread Sanitizer
  # ==========================================================================
  thread-sanitizer:
    name: Thread Sanitizer (TSan)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake with ThreadSanitizer
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DORIP_BUILD_TESTS=ON -DORIP_ENABLE_TSAN=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests with ThreadSanitizer
      working-directory: build
      run: ctest --output-on-failure
      env:
        TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1

  # ==========================================================================
  # Fuzz Testing
  # ==========================================================================
  fuzzing:
    name: Fuzz Testing
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Clang
      run: |
        sudo apt-get update
        sudo apt-get install -y clang

    - name: Configure CMake with fuzzing
      run: |
        CC=clang CXX=clang++ cmake -B build -DCMAKE_BUILD_TYPE=Release -DORIP_BUILD_FUZZ=ON -DORIP_BUILD_TESTS=OFF

    - name: Build fuzz target
      run: cmake --build build --target fuzz_parser --parallel

    - name: Create seed corpus
      run: |
        mkdir -p build/fuzz_corpus
        # Copy existing corpus seeds if available
        if [ -d "fuzz/corpus" ]; then
          cp -r fuzz/corpus/* build/fuzz_corpus/ 2>/dev/null || true
        fi

    - name: Run fuzz tests (60 seconds)
      run: |
        cd build
        ./fuzz_parser fuzz_corpus -max_len=512 -timeout=5 -max_total_time=60 -print_final_stats=1
      continue-on-error: false

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fuzz-crashes
        path: |
          build/crash-*
          build/leak-*
          build/timeout-*

  # ==========================================================================
  # Performance Benchmarks
  # ==========================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake with benchmarks
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DORIP_BUILD_BENCHMARKS=ON

    - name: Build benchmarks
      run: cmake --build build --target orip_benchmarks --parallel

    - name: Run benchmarks
      working-directory: build
      run: ./orip_benchmarks --benchmark_format=json --benchmark_out=benchmark_results.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: build/benchmark_results.json

  # ==========================================================================
  # Python Build and Test
  # ==========================================================================
  python-build:
    name: Python (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Build C++ shared library
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DORIP_BUILD_SHARED=ON
        cmake --build . --parallel
        sudo cmake --install .
        sudo ldconfig

    - name: Install Python package
      working-directory: python
      run: |
        pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run Python tests
      working-directory: python
      run: pytest tests/ -v

  # ==========================================================================
  # Android Build
  # ==========================================================================
  android-build:
    name: Android
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build Android library
      working-directory: android
      run: ./gradlew :orip:assembleRelease

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: orip-release-aar
        path: android/orip/build/outputs/aar/*.aar

  # ==========================================================================
  # Code Quality
  # ==========================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install clang-format
      run: sudo apt-get install -y clang-format

    - name: Check C++ formatting
      run: |
        find include src -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python linters
      run: pip install ruff mypy

    - name: Lint Python code
      working-directory: python
      run: |
        ruff check orip/

    - name: Type check Python code
      working-directory: python
      run: |
        mypy orip/ --ignore-missing-imports

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check README links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/mlc_config.json'

  # ==========================================================================
  # Release Build
  # ==========================================================================
  release:
    name: Release Build
    runs-on: ubuntu-latest
    needs: [cpp-build, python-build, android-build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Build release artifacts
      run: |
        mkdir -p release
        # Build static library
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel
        cp liborip.a ../release/

    - name: Download Android AAR
      uses: actions/download-artifact@v4
      with:
        name: orip-release-aar
        path: release/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
